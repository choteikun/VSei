using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using SonicBloom;
using SonicBloom.Koreo;
using UnityEngine.UI;
using UnityEngine.SceneManagement;
using SonicBloom.Koreo.Players;

public class RythmBeatSpawner : MonoBehaviour
{
    [Tooltip("譜面生成的物件")]
    public GameObject obstaclePrefab;
    [Tooltip("依據歌單選擇的歌曲號碼Data")]
    public SongsInfo songsInfo;

    public GameObject sensorLL;
    public GameObject sensorL;
    public GameObject sensorR;
    public GameObject sensorRR;

    public int curTime;//當前時間
    public int spawnTime;//紀錄當前生成節拍的時間
    public int beatsLimitTimeDifference;//取一個值用於限制拍子間的時間差
    public int curCheckIdx;//Event Element

    public AudioSource audioCom;


    [EventID]
    public string normalEventID;
    //[EventID]
    //public string hardEventID;
    //public Koreography koreography;
    public List<KoreographyEvent> rhythmEvents;
    //獲取musicplayer script
    public SimpleMusicPlayer musicPlayer;
    //koreography list
    public List<Koreography> loadedKoreo = new();

    //bool changeTrack;
    private ExcelLineManage LineManageNormal;
    //private ExcelLineManage LineManageHard;

    public enum SensorSet
    {
        SensorLL_SetPosX,
        SensorL_SetPosX,
        SensorR_SetPosX,
        SensorRR_SetPosX
    }
    public SensorSet sensorSet;

    void Awake()
    {
        switch (songsInfo.songNumIs)
        {
            case 1:
                normalEventID = "StreetCityPop_SnareDrum";
                LineManageNormal = Resources.Load<ExcelLineManage>("Release/rythmBeatSet_StreetCityPop");
                break;
            case 2:
                normalEventID = "Take_Off_Into_the_Sky_SnareDrum";
                LineManageNormal = Resources.Load<ExcelLineManage>("Release/rythmBeatSet_Take_Off_Into_the_Sky");
                break;
            default:
                break;
        }
        
        
    }
    void Start()
    {
        Koreographer.Instance.GetAllLoadedKoreography(loadedKoreo);

        rhythmEvents = loadedKoreo[songsInfo.songNumIs - 1].GetTrackByID(normalEventID).GetAllEvents();
        Koreographer.Instance.RegisterForEvents(normalEventID, NormalMaker);
        //Koreographer.Instance.RegisterForEvents(hardEventID, HardMaker);
        musicPlayer.LoadSong(loadedKoreo[songsInfo.songNumIs - 1]);

        ////Initialize events.
        //koreography = Koreographer.Instance.GetKoreographyAtIndex(0);

        //// Grab all the events out of the Koreography.
        //rhythmEvents = koreography.GetTrackByID(eventID).GetAllEvents();

        //Koreographer.Instance.RegisterForEvents(eventID, Maker);

        //musicPlayer.LoadSong(koreography);

        //LineManageNormal = Resources.Load<ExcelLineManage>("Release/rythmBeatSetTest");
        //LineManageHard = Resources.Load<ExcelLineManage>("Release/XXX");

        curCheckIdx = 0;
        spawnTime = 0;
    }
    void Update()
    {
        if (curCheckIdx < rhythmEvents.Count)
        {
            curTime = Koreographer.GetSampleTime();
            Debug.Log("Element " + curCheckIdx);//第幾拍
            Debug.Log("curTime" + curTime);
            Debug.Log("StartSample" + rhythmEvents[curCheckIdx].StartSample);
            if (curTime > rhythmEvents[curCheckIdx].StartSample)
            {
                curCheckIdx++;
                //Debug.Log("Element" + curCheckIdx);
            }
        }
        
    }
    void NormalMaker(KoreographyEvent koreographyEvent)
    {
        if (curTime - spawnTime > beatsLimitTimeDifference)//最少要超過多少beatsTimeDifference才生成節拍
        {
            if (LineManageNormal.dataArray[curCheckIdx].BeatPosLL == "1")//按照excel上的表格位置
            {
                //sensorSet = SensorSet.SensorLL_SetPosX;
                PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorLL.transform.position.x, 0, 0), Quaternion.identity);//生成節拍
                spawnTime = curTime;
            }
            if (LineManageNormal.dataArray[curCheckIdx].BeatPosL == "1")
            {
                //sensorSet = SensorSet.SensorL_SetPosX;
                PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorL.transform.position.x, 0, 0), Quaternion.identity);
                spawnTime = curTime;
            }
            if (LineManageNormal.dataArray[curCheckIdx].BeatPosR == "1")
            {
                //sensorSet = SensorSet.SensorR_SetPosX;
                PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorR.transform.position.x, 0, 0), Quaternion.identity);
                spawnTime = curTime;
            }
            if (LineManageNormal.dataArray[curCheckIdx].BeatPosRR == "1")
            {
                //sensorSet = SensorSet.SensorRR_SetPosX;
                PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorRR.transform.position.x, 0, 0), Quaternion.identity);
                spawnTime = curTime;
            }
            if ((LineManageNormal.dataArray[curCheckIdx].BeatPosLL != "1" && LineManageNormal.dataArray[curCheckIdx].BeatPosL != "1" && LineManageNormal.dataArray[curCheckIdx].BeatPosR != "1" && LineManageNormal.dataArray[curCheckIdx].BeatPosRR != "1")
                &&(LineManageNormal.dataArray[curCheckIdx].BeatPosLL != "0" && LineManageNormal.dataArray[curCheckIdx].BeatPosL != "0" && LineManageNormal.dataArray[curCheckIdx].BeatPosR != "0" && LineManageNormal.dataArray[curCheckIdx].BeatPosRR != "0")
                ) //若excel裡沒有任何數字是1&0則隨機安排位置(一橫排只會有1個節拍生成)
            {
                Debug.Log("no rythmBeats");
                switch (sensorSet)//分配位置
                {
                    case SensorSet.SensorLL_SetPosX:

                        //Instantiate(obstaclePrefab, transform.position + new Vector3(sensorLL.transform.position.x, 0, 0), Quaternion.identity);
                        PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorLL.transform.position.x, 0, 0), Quaternion.identity);//生成節拍
                        spawnTime = curTime;
                        break;
                    case SensorSet.SensorL_SetPosX:

                        //Instantiate(obstaclePrefab, transform.position + new Vector3(sensorL.transform.position.x, 0, 0), Quaternion.identity);
                        PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorL.transform.position.x, 0, 0), Quaternion.identity);
                        spawnTime = curTime;
                        break;
                    case SensorSet.SensorR_SetPosX:

                        //Instantiate(obstaclePrefab, transform.position + new Vector3(sensorR.transform.position.x, 0, 0), Quaternion.identity);
                        PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorR.transform.position.x, 0, 0), Quaternion.identity);
                        spawnTime = curTime;
                        break;
                    case SensorSet.SensorRR_SetPosX:

                        //Instantiate(obstaclePrefab, transform.position + new Vector3(sensorRR.transform.position.x, 0, 0), Quaternion.identity);
                        PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorRR.transform.position.x, 0, 0), Quaternion.identity);
                        spawnTime = curTime;
                        break;
                    default:
                        break;
                }
                sensorSet = (SensorSet)Random.Range(0, System.Enum.GetValues(typeof(SensorSet)).Length);
            }
            //Debug.Log("Element" + curCheckIdx);

            //obstaclePrefab.name = "Element" + curCheckIdx;
        }
    }
    //void HardMaker(KoreographyEvent koreographyEvent)
    //{
    //    if (curTime - spawnTime > beatsLimitTimeDifference)//最少要超過多少beatsTimeDifference才生成節拍
    //    {
    //        if (LineManageHard.dataArray[curCheckIdx - 1].BeatPosLL == "1")//按照excel上的表格位置
    //        {
    //            //PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorLL.transform.position.x, 0, 0), Quaternion.identity);//生成節拍
    //            spawnTime = curTime;
    //        }
    //        if (LineManageHard.dataArray[curCheckIdx - 1].BeatPosL == "1")
    //        {
    //            //PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorL.transform.position.x, 0, 0), Quaternion.identity);
    //            spawnTime = curTime;
    //        }
    //        if (LineManageHard.dataArray[curCheckIdx - 1].BeatPosR == "1")
    //        {
    //            //PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorR.transform.position.x, 0, 0), Quaternion.identity);
    //            spawnTime = curTime;
    //        }
    //        if (LineManageHard.dataArray[curCheckIdx - 1].BeatPosRR == "1")
    //        {
    //            //PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorRR.transform.position.x, 0, 0), Quaternion.identity);
    //            spawnTime = curTime;
    //        }
    //        if (LineManageHard.dataArray[curCheckIdx - 1].BeatPosLL != "1" && LineManageNormal.dataArray[curCheckIdx - 1].BeatPosL != "1" && LineManageNormal.dataArray[curCheckIdx - 1].BeatPosR != "1" && LineManageNormal.dataArray[curCheckIdx - 1].BeatPosRR != "1") //若excel裡沒有任何數字是1則隨機安排位置(一橫排只會有1個節拍生成)
    //        {
    //            Debug.Log("no rythmBeats");
    //            switch (sensorSet)//分配位置
    //            {
    //                case SensorSet.SensorLL_SetPosX:
    //                    PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorLL.transform.position.x, 0, 0), Quaternion.identity);//生成節拍
    //                    spawnTime = curTime;
    //                    break;
    //                case SensorSet.SensorL_SetPosX:
    //                    PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorL.transform.position.x, 0, 0), Quaternion.identity);
    //                    spawnTime = curTime;
    //                    break;
    //                case SensorSet.SensorR_SetPosX:
    //                    PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorR.transform.position.x, 0, 0), Quaternion.identity);
    //                    spawnTime = curTime;
    //                    break;
    //                case SensorSet.SensorRR_SetPosX:
    //                    PoolManager.Release(obstaclePrefab, transform.position + new Vector3(sensorRR.transform.position.x, 0, 0), Quaternion.identity);
    //                    spawnTime = curTime;
    //                    break;
    //                default:
    //                    break;
    //            }
    //            sensorSet = (SensorSet)Random.Range(0, System.Enum.GetValues(typeof(SensorSet)).Length);
    //        }
    //        //Debug.Log("Element" + curCheckIdx);
    //        //obstaclePrefab.name = "Element" + curCheckIdx;
    //    }
    //}

    public void Restart()
    {
        // Reset the audio.
        //audioCom.Stop();
        //audioCom.time = 0f;
        //audioCom.Play();
        Time.timeScale = 1;
        SceneManager.LoadScene("GameScene");
    }
    public void PauseButton()
    {
        audioCom.Pause();
        Time.timeScale = 0;
    }
    public void ResumeButton()
    {
        audioCom.Play();
        Time.timeScale = 1;
    }
    public void BackHomeScene()
    {
        Time.timeScale = 1;
        SceneManager.LoadScene("HomeScene");
    }

}
